{% extends 'frontpage/base.html' %}

{% load static %}

    <head>
        <meta charset="UTF-8">
    </head>


{% block content %}
    <div>
        <h2>Teste de Fluência Verbal Semântica</h2>
        <p>Esse teste consiste em se falar o maior número de animais que o(a) paciente conseguir lembrar dentro do <br>
            intervalo de 1 minuto. Para realizar o teste através desse site, por favor verifique a presença <br>
            do microfone e quando estiver pronto clique no botão abaixo.</p>
    </div>

    <div>
        <form method="POST" class="postform" enctype="multipart/form-data" id="sendData">
            {% csrf_token %}
<!--            {{ test.as_p }}-->
            Status2: <input type="text" id="status2" value="Aguardando">
            <input type="hidden" id="pacienteID" value="{{paciente}}">
        </form>
        <button id="rec" onclick="record(paciente())">Record</button>
    </div>

    <script>
        function paciente() {
            var x = document.getElementById("pacienteID").value;
            return x
        }

        function record(pac) {
            document.getElementById("status2").value = pac;
            let constraintObj = { audio: true, video: false }
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
                navigator.mediaDevices.getUserMedia = function(constraintObj) {
                    let getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                    if (!getUserMedia) {
                        document.getElementById("status2").value = 'fudeu';
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }
                    return new Promise(function(resolve, reject) {
                        document.getElementById("status2").value = 'cheguei aqui';
                        getUserMedia.call(navigator, constraintObj, resolve, reject);
                    });
                }
            } else {
                document.getElementById("status2").value = 'olha esses devices';
                navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    devices.forEach(device=>{
                        console.log(device.kind.toUpperCase(), device.label);
                        //, device.deviceId
                    })
                })
                .catch(err=>{
                    console.log(err.name, err.message);
                })
            }

            navigator.mediaDevices.getUserMedia(constraintObj).then(stream => {
                const mediaRecorder = new MediaRecorder(stream);
                document.getElementById("status2").value = 'gravando';
                rec.disabled = true;
                //rec.style.backgroundColor = "blue";
                mediaRecorder.start();

                const chunks = [];

                mediaRecorder.addEventListener("dataavailable", event => {
                    chunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(chunks,{type: 'audio/wav'});

                    // código pra mandar o audio pro servidor/backend
                    //document.getElementById("audio_data").value = audioBlob;
                    //document.getElementById("sendData").click();
                    document.getElementById("status2").value = 'processando';
                    //upload(audioBlob,pac);

                    //testaAudio(audioBlob);
                });

                setTimeout(() => {
                    document.getElementById("status2").value = 'processando';
                    mediaRecorder.stop();
                }, 3000);
            })
            .catch(function(err) {
                document.getElementById("status2").value = 'deu ruim';
                console.log(err.name, err.message);
            });
        }

        function getCookie(pac) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, pac.length + 1) == (pac + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(pac.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function upload(blob,pac) {
            var csrftoken = getCookie('csrftoken');
            document.getElementById("status2").value = 'upando';
            var xhr = new XMLHttpRequest();
            var fd = new FormData();
            fd.append("audio_data", blob);
            xhr.open('POST', 'http://127.0.0.1:8000/media/', true);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.setRequestHeader("MyCustomHeader", pac);

            xhr.upload.onloadend = function() {
                alert('Upload complete');
            };
            // If you want you can show the upload progress using a progress bar
            //var progressBar = document.querySelector('progress');
            //xhr.upload.onprogress = function(e) {
            //   if (e.lengthComputable) {
            //        progressBar.value = (e.loaded / e.total) * 100;
            //        progressBar.textContent = progressBar.value; // Fallback for unsupported browsers.
            //    }
            //};

            xhr.send(fd);

            document.getElementById("sendData").submit();
        }

        function upload1(blob){
            var xhr = new XMLHttpRequest();
            xhr.onload = function(e) {
                if(this.readyState === 4) {
                    console.log("Server returned: ",e.target.responseText);
                }
            };
            var fd = new FormData();
            fd.append("audio_data", blob);
            xhr.open("POST", "http://127.0.0.1:8000/media/", true);
            xhr.send(fd);
            document.getElementById("status2").value = fd;
            document.getElementById("sendData").submit();
        }
    </script>

    <script>
        function testaAudio(blob){
            const audioUrl = URL.createObjectURL(blob);
            const audio = new Audio(audioUrl);
            audio.play();
        }
    </script>

{% endblock %}